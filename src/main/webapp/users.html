<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8">
	<title>User management Web UI</title>
	<script type="application/javascript" src="jquery/jquery-1.11.3.js"></script>
	<script type="application/javascript" src="jquery-ui/jquery-ui.js"></script>
	<script type="application/javascript" src="jqgrid/js/jquery.jqGrid.js"></script>
	<script type="application/javascript" src="jqgrid/js/i18n/grid.locale-en.js"></script>
	<script type="application/javascript" src="js/user-utils.js"></script>
	<script type="application/javascript" src="js/ajax-utils.js"></script>
	<script type="application/javascript" src="js/menu-utils.js"></script>	
	
	<link rel="stylesheet" type="text/css" media="screen" href="jquery-ui/jquery-ui.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="jqgrid/css/ui.jqgrid.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
	<script type="application/javascript">
		var userUtils = null;
		var selectedUser = null;
		function editUser(uid) {
			var user = $("#users-grid").jqGrid('getRowData', uid);
			selectedUser = user;
			console.log(user);
			userUtils.setUser(user);
			$("#user-dialog").dialog("open"); 
		}
		
		function split( val ) {
			return val.split( /;\s*/ );
		}
		
		function extractLast( term ) {
  			return split( term ).pop();
		}
	
		$(document).ready(function () {
			var ajaxUtils = new AjaxUtils($('#loading-div'));
			var menuUtils = new MenuUtils();
			
			
			var dialog = $("#user-dialog");
			userUtils = new UserUtils(dialog);
			
			
			var w = $(window).width() - 50;
			var h = $(window).height() - 150;
			var rowNum = 20;
			if (h > 1024) {
				rowNum = 100;
			} else if (h > 700) {
				rowNum = 50;
			}
			$("#users-grid").jqGrid({
				url: 'ws/users/rows',
				datatype: "json",
				colModel: [
					{ label: ' ', name: 'add', width: 16, sortable: false, search: false,
	  					formatter:function(cellvalue, options, rowObject) {
	      					return "<span class='ui-icon ui-icon-pencil' onclick='editUser(\"" + rowObject.uid.replace(/"/g, '\\\"') + "\")'></span>";
	  					}	
					},				           
					{ label: 'ID', name: 'uid', width: 150, key:true },
					{ label: 'First name', name: 'firstName', width: 150 },
					{ label: 'Last name', name: 'lastName', width: 150 },
					{ label: 'Full name', name: 'fullName', width: 150 },
					{ label: 'Display name', name: 'displayName', width: 150 },
					{ label: 'Email', name: 'email', width: 250 },
					{ label: 'Groups', name: 'groups', width: 250 }
				],
				viewrecords: true,
				shrinkToFit: true,
				//autowidth: true,
				width: w, 
				height: h,
				rowNum: rowNum,
				rowList: [10, 20, 50, 100, 500],
				loadonce: true,
				pager: "#users-grid-pager"
			});
			
			dialog.dialog({
				autoOpen: false,
				height: 500,
				width: 350,
				modal: true,
				close: function() { userUtils.reset(); },
				buttons: { 
					"Save": function() { userUtils.submit(); },
					"Cancel": function() { userUtils.closeDialog(); }
				}
			});
			 
			dialog.find("form").on("submit", function( event ) {				
				event.preventDefault();
				var isNew = (selectedUser == null);
				var user = userUtils.validate(isNew);
				if (user != null) {
					var form = $(this);					
					var url;
					if (isNew) {
						url = "ws/users/create";	
					} else {
						url = "ws/users/update";
					}
					 
					// Send the data using post
					var posting = $.post( url, { "user": JSON.stringify(user) } );
				 
					// Put the results in a div
					posting.done(function( data ) {					
						console.log(data);
						$("#users-grid").jqGrid('setGridParam',{datatype:'json'}).trigger('reloadGrid');
					});
				}
			});
			
			$("#create-user").click( function() {
				selectedUser = null;
				userUtils.reset();
				$("#user-dialog").dialog("open"); 
			} );
			
			$("#groups")
				// don't navigate away from the field on tab when selecting an item
				.bind( "keydown", function( event ) {
					if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete("instance").menu.active) {
						event.preventDefault();
					}
				})
				.autocomplete({
					source: function(request, response) {
						$.getJSON("ws/groups/searchGroups", { search : extractLast(request.term) }, function(data) {
							response(data.groups);
						});
					},
					search: function() {
						// custom minLength
						var term = extractLast(this.value);
						if (term.length < 2) {
							return false;
						}
					},
					focus: function() {
						// prevent value inserted on focus
						return false;
					},
					select: function(event, ui) {
						var terms = split( this.value );
						// remove the current input
						terms.pop();
						// add the selected item
						terms.push(ui.item.value);
						// add placeholder to get the comma-and-space at the end
						terms.push("");
						this.value = terms.join("; ");
						return false;
					}
		      });
			
		}); 
	</script>
</head>
<body>
	<div id="loading-div" class="ajax-loader" style="display:none">
		<img src="images/loading-gears-animation-3.gif" width="100px" height="70px" style="margin: 5px 0px 0px 5px"/>
	</div>
	
	<div id="user-dialog" title="Create new user" class="add-edit-dialog">
		<p class="validateTips">All form fields are required.</p>
	
		<form>
			<fieldset>
				<label for="uid">ID</label>
				<input type="text" name="uid" id="uid" value="" class="text ui-widget-content ui-corner-all">
			
				<label for="name">First Name</label>
				<input type="text" name="firstName" id="first-name" value="John" class="text ui-widget-content ui-corner-all">
				
				<label for="name">Last Name</label>
				<input type="text" name="lastName" id="last-name" value="Doe" class="text ui-widget-content ui-corner-all">
				
				<label for="name">Full Name</label>
				<input type="text" name="fullName" id="full-name" value="Doe" class="text ui-widget-content ui-corner-all">
				
				<label for="name">Display Name</label>
				<input type="text" name="displayName" id="display-name" value="Doe" class="text ui-widget-content ui-corner-all">
				
				<label for="email">Email</label>
				<input type="text" name="email" id="email" value="john@doe.com" class="text ui-widget-content ui-corner-all">
				
				<label for="password">Password</label>
				<input type="password" name="password" id="password" value="xxxxxxx" class="text ui-widget-content ui-corner-all">
				
				<label for="groups">Groups</label>
				<input type="text" name="groups" id="groups" class="text ui-widget-content ui-corner-all">
				
				<!-- Allow form submission with keyboard without duplicating the dialog button -->
				<input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
			</fieldset>
		</form>
	</div>


	<div class="menu">
		<ul>
			<li class="admin-role-required"><a href="users.html"><i class="fa fa-fw fa-user"></i> Users</a></li>
			<li class="admin-role-required"><a href="groups.html"><i class="fa fa-fw fa-group"></i> Groups</a></li>
			<li><a href="profile.html"><i class="fa fa-fw fa-cog"></i> Profile</a></li>
			<li><a href="ws/users/logout"><i class="fa fa-fw fa-sign-out"></i> Logout</a></li>
		</ul>
	</div>

	<div class="content">
		<table id="users-grid"></table>
	    <div id="users-grid-pager"></div>
	    <button id="create-user">Create new user</button>
    </div>
</body>
</html>